<% content_for :head do %>
	<%= subscribe_to "/parties/#{@party.id}" %>
<% end %>

<% content_for :title, "Streaming for #{@party.name}" %>

<div>
    <p id="not-supported" style="display:none">Sorry your browser does not support getUserMedia or it is disabled</p>
    <button id="start">Start streaming</button><br>
    <video id="live" width="320" height="240" autoplay style="display: inline;background-color:black"></video>
    <canvas width="320" id="canvas" height="240" style="display:none"></canvas>
</div>

<%= form_tag party_stream_path(@party), id: 'STREAMER', remote: true do %>
	<%= hidden_field_tag :c %>
<% end %>

<script type="text/javascript">
	function dataURItoBlob(dataURI) {
	    var binary = atob(dataURI.split(',')[1]);
	    var array = [];
	    for(var i = 0; i < binary.length; i++) {
	        array.push(binary.charCodeAt(i));
	    }
	    return new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
	}

	var video = $("#live").get()[0];
	var canvas = $("#canvas");
	var ctx = canvas.get()[0].getContext('2d');

	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;

	window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL; 
	if (navigator.getUserMedia) {    
		document.getElementById('start').addEventListener('click', function(){
			navigator.getUserMedia({video: true}, handleVideo, videoError);

			function handleVideo(stream) {
				video.src = window.URL.createObjectURL(stream);
			}

			function videoError(e) {

			}

			setInterval(function() {
				ctx.drawImage(video, 0, 0, 320, 240);
				$('#STREAMER input[name=c]').val(canvas.get()[0].toDataURL('image/jpeg', 1.0));
				$('#STREAMER').trigger('submit.rails');
			}, 100);
		});
	} else {
		document.getElementById('not-supported').removeAttribute('style');
		document.getElementById('start').setAttribute('disabled', 'disabled');
	}	        
</script>
